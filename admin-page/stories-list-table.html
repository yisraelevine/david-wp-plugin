<div id="stories-list">
	<h2>רשימת סיפורים</h2>
	<div class="pagination"></div>
	<table>
		<thead>
			<tr>
				<th>שם</th>
				<th>קישור</th>
				<th>חדש</th>
				<th>טלפון</th>
			</tr>
		</thead>
		<tbody></tbody>
		<tfoot>
			<tr>
				<th>שם</th>
				<th>קישור</th>
				<th>חדש</th>
				<th>טלפון</th>
			</tr>
		</tfoot>
	</table>
	<div class="pagination"></div>
</div>
<style>
	#stories-list {
		transition: 1s;
	}

	#stories-list.loading {
		opacity: 0;
		transition: none;
		pointer-events: none;
	}

	#stories-list table {
		margin: 6px 0;
		text-align: right;
		width: 100%;
		border: 1px solid #c3c4c7;
		box-shadow: 0 1px 1px rgba(0, 0, 0, .04);
	}

	#stories-list table tbody tr:nth-child(odd) {
		background-color: #f6f7f7;
	}

	#stories-list table tbody td:nth-child(1) {
		width: 200px;
	}

	#stories-list table tbody td:nth-child(2) {
		width: 600px;
	}

	#stories-list table tbody td:nth-child(3),
	#stories-list table tbody td:nth-child(4) {
		width: 50px;
	}

	#stories-list table input[type=text],
	#stories-list table input[type=url] {
		border: 0;
		border-radius: 0;
		background-color: transparent;
		color: #4e4e4e;
		margin: 0;
		padding: 4px 6px;
		line-height: 1;
		min-height: unset;
		width: 100%;
	}

	#stories-list .pagination {
		font-size: 14px;
		display: flex;
		align-items: center;
		justify-content: flex-end;
		gap: 2px;
	}

	#stories-list .pagination a {
		text-decoration: none;
		cursor: pointer;
	}

	#stories-list .pagination a:focus {
		box-shadow: none;
	}

	#stories-list .pagination input {
		outline: 0;
	}

	#stories-list .pagination span {
		margin-inline: 4px;
	}

	#stories-list .pagination a,
	#stories-list .pagination input {
		align-content: center;
		box-sizing: border-box;
		width: 40px;
		height: 32px;
		text-align: center;
		border: 1px solid;
		border-radius: 4px;
		margin: 0;
	}

	#stories-list .pagination a[disabled] {
		color: gray;
		opacity: .4;
		cursor: default;
		pointer-events: none;
	}
</style>
<script>
	const setParam = (paged) => {
		const url = new URL(window.location.href);
		url.searchParams.set('paged', paged);

		window.history.pushState('', '', url);
	}

	const stories_list = document.querySelector('#stories-list');
	const tbody = stories_list.querySelector('table tbody');
	const pagination_nodes = stories_list.querySelectorAll('.pagination');

	const load = async (paged) => {
		stories_list.classList.add('loading');

		const limit = 50;
		const offset = (paged - 1) * limit;

		const url = `/wp-json/stories/v1/list-admin/?offset=${offset}&limit=${limit}`;
		const options = { method: 'GET', headers: { 'X-WP-Nonce': sessionStorage.wpRestNonce } }
		const response = await fetch(url, options);
		let { count, list } = await response.json();

		list = list.map(e => `<tr>
			<td>
				<input data-id="${e.id}" type="text" value="${e.name}" name="name" autocomplete="off" />
			</td>
			<td>
				<input data-id="${e.id}" type="url" value="${decodeURIComponent(e.url)}" name="url" />
			</td>
			<td>
				<input data-id="${e.id}" type="checkbox" ${+e.is_new ? 'checked' : ''} name="is_new" />
			</td>
			<td>
				<input data-id="${e.id}" type="checkbox" ${+e.is_phone ? 'checked' : ''} name="is_phone" />
			</td>
		</tr>`);

		tbody.innerHTML = list.join('');

		const tbody_input_nodes = tbody.querySelectorAll('input[type=text], input[type=url]');
		const tbody_input_checkbox_nodes = tbody.querySelectorAll('input[type=checkbox]');

		const tbody_input_event = async (event) => {
			const id = event.target.dataset.id;

			const nodes = tbody.querySelectorAll(`[data-id="${id}"]`);

			const data = { id: +id };

			nodes.forEach(e => {
				const value = e.type === 'checkbox' ? e.checked : e.value;
				data[e.name] = value;
			});

			await fetch('/wp-json/stories/v1/update-story/', {
				method: 'POST',
				body: JSON.stringify(data),
				headers: {
					'Content-Type': 'application/json',
					'X-WP-Nonce': sessionStorage.wpRestNonce
				}
			});
		};

		tbody_input_nodes.forEach(e => {
			e.addEventListener('blur', tbody_input_event);
			e.addEventListener('keydown', (event) => {
				if (event.key !== 'Enter') return;
				tbody_input_event(event);
			});
		});
		tbody_input_checkbox_nodes.forEach(e => e.addEventListener('change', tbody_input_event));

		const pages = Math.ceil(count / limit);
		const is_first = paged === 1;
		const is_last = paged === pages;
		const first_page = is_first ? 'disabled' : `data-paged="${1}"`;
		const prev_page = is_first ? 'disabled' : `data-paged="${paged - 1}"`;
		const next_page = is_last ? 'disabled' : `data-paged="${paged + 1}"`;
		const last_page = is_last ? 'disabled' : `data-paged="${pages}"`;

		const pagination = `<span>${count} סיפורים</span>
		<a ${first_page}>&lt&lt</a>
		<a ${prev_page}>&lt</a>
		<input value="${paged}" name="paged" />
		<span> מתוך ${pages}</span>
		<a ${next_page}>&gt</a>
		<a ${last_page}>&gt&gt</a>`;

		pagination_nodes.forEach(e => {
			e.innerHTML = pagination;
		});

		const pagination_input_nodes = stories_list.querySelectorAll('.pagination input');
		const pagination_a_nodes = stories_list.querySelectorAll('.pagination a');

		const pager = async (paged) => {
			if (!paged) {
				return;
			}

			await load(paged);

			setParam(paged);
		}

		const pagination_input_event = async (event) => {
			if (event.type === 'blur' || event.key === 'Enter') {
				const paged = event.target.value;
				await pager(+paged);
			}
		};
		const pagination_a_event = async (event) => {
			await pager(+event.target.dataset.paged);
		};

		pagination_input_nodes.forEach(e => {
			e.addEventListener('blur', pagination_input_event);
			e.addEventListener('keydown', pagination_input_event);
		});
		pagination_a_nodes.forEach(e => {
			e.addEventListener('click', pagination_a_event);
		});

		stories_list.classList.remove('loading');
	};

	const params = new URLSearchParams(window.location.href)
	const paged = params.get('paged');

	load(+paged || 1);
</script>